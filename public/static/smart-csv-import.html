<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½CSVæ‰¹é‡å¯¼å…¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .drag-area {
            border: 2px dashed #ccc;
            transition: all 0.3s ease;
        }
        .drag-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-6xl p-6">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-magic mr-3 text-purple-600"></i>æ™ºèƒ½CSVæ‰¹é‡å¯¼å…¥
            </h1>
            
            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="mb-8 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>æ™ºèƒ½å¯¼å…¥ç‰¹æ€§
                </h3>
                <div class="text-blue-700 space-y-2">
                    <p>âœ¨ <strong>è‡ªåŠ¨è¡¥å…¨</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ‚¨çš„æ•°æ®ç”Ÿæˆç¼ºå¤±çš„å­—æ®µ</p>
                    <p>ğŸ”§ <strong>æ™ºèƒ½SKU</strong>ï¼šæ ¹æ®äº§å“åç§°è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„SKUç¼–ç </p>
                    <p>ğŸ“‹ <strong>é»˜è®¤åˆ†ç±»</strong>ï¼šè‡ªåŠ¨è®¾ç½®ä¸º"è¿æ¥å™¨"åˆ†ç±»</p>
                    <p>ğŸ›¡ï¸ <strong>å†²çªå¤„ç†</strong>ï¼šè‡ªåŠ¨å¤„ç†é‡å¤æ•°æ®ï¼Œç¡®ä¿å¯¼å…¥æˆåŠŸ</p>
                </div>
            </div>

            <!-- CSVæ ¼å¼æ”¯æŒ -->
            <div class="mb-8 p-4 bg-green-50 border-l-4 border-green-400 rounded">
                <h3 class="text-lg font-semibold text-green-800 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>æ”¯æŒçš„CSVæ ¼å¼
                </h3>
                <div class="text-green-700">
                    <p class="mb-2"><strong>ä¸­æ–‡æ ‡é¢˜æ ¼å¼ï¼ˆæ¨èï¼‰</strong>ï¼š</p>
                    <code class="bg-green-100 px-2 py-1 rounded block mb-3">å•†å“åç§°,å…¬å¸åç§°,å”®ä»·,åº“å­˜</code>
                    
                    <p class="mb-2"><strong>è‹±æ–‡æ ‡é¢˜æ ¼å¼</strong>ï¼š</p>
                    <code class="bg-green-100 px-2 py-1 rounded block mb-3">name,company_name,price,stock</code>
                    
                    <p class="mb-2"><strong>å®Œæ•´æ ¼å¼ï¼ˆå¯é€‰å­—æ®µï¼‰</strong>ï¼š</p>
                    <code class="bg-green-100 px-2 py-1 rounded block">å•†å“åç§°,å…¬å¸åç§°,å”®ä»·,åº“å­˜,SKU,åˆ†ç±»,æè¿°</code>
                    
                    <p class="mt-3 text-sm">ğŸ’¡ ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ‚¨çš„CSVæ ¼å¼å¹¶æ™ºèƒ½è¡¥å…¨ç¼ºå¤±å­—æ®µ</p>
                    
                    <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                        <p class="text-sm font-medium text-green-800 mb-2">ğŸ“ ç¤ºä¾‹æ•°æ®ï¼š</p>
                        <pre class="text-xs text-green-700 overflow-x-auto">å•†å“åç§°,å…¬å¸åç§°,å”®ä»·,åº“å­˜
USB Type-C è¿æ¥å™¨,è‹¹æœå…¬å¸,15.99,100
HDMI é«˜æ¸…è¿æ¥å™¨,ä¸‰æ˜Ÿç”µå­,25.50,50
ä»¥å¤ªç½‘è¿æ¥å™¨,åä¸ºæŠ€æœ¯,8.88,200</pre>
                    </div>
                </div>
            </div>

            <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
            <div id="dragArea" class="drag-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 cursor-pointer mb-6">
                <div class="space-y-4">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400"></i>
                    <div>
                        <p class="text-2xl font-medium text-gray-600">æ‹–æ‹½CSVæ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p class="text-gray-500 mt-2">æˆ– <span class="text-blue-600 underline font-medium">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></p>
                    </div>
                    <input type="file" id="csvFile" class="hidden" accept=".csv" />
                </div>
            </div>

            <!-- æ–‡ä»¶ä¿¡æ¯å’Œé¢„è§ˆ -->
            <div id="fileSection" class="hidden space-y-6 mb-8">
                <!-- æ–‡ä»¶ä¿¡æ¯ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-file-csv mr-2"></i>æ–‡ä»¶ä¿¡æ¯
                    </h4>
                    <div id="fileInfo" class="text-sm text-blue-700"></div>
                </div>

                <!-- æ•°æ®é¢„è§ˆ -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-eye mr-2"></i>æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰
                    </h4>
                    <div class="overflow-x-auto bg-white border rounded-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr id="previewHeader"></tr>
                            </thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- å¯¼å…¥æ§åˆ¶ -->
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div class="text-gray-700">
                        <span id="totalRows">0</span> è¡Œæ•°æ®å‡†å¤‡å¯¼å…¥
                    </div>
                    <div class="space-x-4">
                        <button id="previewBtn" onclick="previewImport()" 
                                class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded transition duration-200">
                            <i class="fas fa-search mr-2"></i>é¢„è§ˆå¤„ç†ç»“æœ
                        </button>
                        <button id="importBtn" onclick="startImport()" 
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded transition duration-200">
                            <i class="fas fa-play mr-2"></i>å¼€å§‹å¯¼å…¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- å¤„ç†ç»“æœé¢„è§ˆ -->
            <div id="previewSection" class="hidden mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-cogs mr-2"></i>æ™ºèƒ½å¤„ç†é¢„è§ˆ
                </h3>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div id="previewResult"></div>
                </div>
            </div>

            <!-- å¯¼å…¥ç»“æœ -->
            <div id="importResult" class="hidden"></div>

            <!-- æ“ä½œå†å² -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-history mr-2"></i>æ“ä½œæ—¥å¿—
                </h3>
                <div id="logContainer" class="bg-white p-3 rounded border max-h-60 overflow-y-auto">
                    <p class="text-gray-600 text-sm">ç­‰å¾…æ“ä½œ...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let authToken = '';
        let selectedFile = null;
        let parsedData = [];

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç™»å½•
        document.addEventListener('DOMContentLoaded', async () => {
            await login();
        });

        // æ‹–æ‹½äº‹ä»¶
        const dragArea = document.getElementById('dragArea');
        const fileInput = document.getElementById('csvFile');

        dragArea.addEventListener('click', () => fileInput.click());
        dragArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragArea.classList.add('dragover');
        });
        dragArea.addEventListener('dragleave', () => {
            dragArea.classList.remove('dragover');
        });
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function login() {
            try {
                const response = await axios.post(`${API_BASE}/api/auth/login`, {
                    username: 'admin',
                    password: 'admin'
                });
                
                if (response.data.success) {
                    authToken = response.data.data.token;
                    log('âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                    return true;
                } else {
                    log('âŒ ç™»å½•å¤±è´¥: ' + response.data.error);
                    return false;
                }
            } catch (error) {
                log('âŒ ç™»å½•å¼‚å¸¸: ' + error.message);
                return false;
            }
        }

        async function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                log('âŒ è¯·é€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            log('ğŸ“ æ­£åœ¨å¤„ç†æ–‡ä»¶...');
            
            try {
                // é¦–å…ˆå°è¯•ä½¿ç”¨UTF-8è¯»å–æ–‡ä»¶
                let csvContent = await file.text();
                let processedFile = file;
                
                // æ£€æµ‹ç¼–ç 
                const encoding = detectEncoding(csvContent);
                
                if (encoding === 'gbk') {
                    log('ğŸ”„ æ£€æµ‹åˆ°GBKç¼–ç ï¼Œæ­£åœ¨è½¬æ¢ä¸ºUTF-8...');
                    try {
                        // è½¬æ¢ç¼–ç 
                        processedFile = await convertGBKToUTF8(file);
                        csvContent = await processedFile.text();
                        log('âœ… ç¼–ç è½¬æ¢æˆåŠŸ');
                    } catch (error) {
                        log('âš ï¸ ç¼–ç è½¬æ¢å¤±è´¥ï¼Œå°è¯•åŸå§‹å†…å®¹: ' + error.message);
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸå§‹å†…å®¹
                    }
                } else {
                    log('âœ… æ£€æµ‹åˆ°UTF-8ç¼–ç ');
                }
                
                selectedFile = processedFile;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                document.getElementById('fileInfo').innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        <div><strong>æ–‡ä»¶åï¼š</strong> ${file.name}</div>
                        <div><strong>å¤§å°ï¼š</strong> ${(file.size / 1024).toFixed(2)} KB</div>
                        <div><strong>ç¼–ç ï¼š</strong> ${encoding === 'gbk' ? 'GBK â†’ UTF-8' : 'UTF-8'}</div>
                    </div>
                `;
                
                // è§£æCSV
                parsedData = parseCSV(csvContent);
                
                if (parsedData.length === 0) {
                    log('âŒ CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    return;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                displayPreview(parsedData);
                document.getElementById('totalRows').textContent = parsedData.length;
                document.getElementById('fileSection').classList.remove('hidden');
                
                log(`ğŸ“„ æˆåŠŸè§£æCSVæ–‡ä»¶ï¼Œå…± ${parsedData.length} è¡Œæ•°æ®`);
                
            } catch (error) {
                log('âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–ç æ£€æµ‹å’Œè½¬æ¢å‡½æ•°
        function detectEncoding(text) {
            // æ£€æµ‹æ˜¯å¦åŒ…å«ä¹±ç å­—ç¬¦ï¼ˆå¸¸è§çš„GBKåœ¨UTF-8ä¸‹çš„æ˜¾ç¤ºï¼‰
            const garbledPatterns = [
                /ï¿½ï¿½/g,              // æœ€å¸¸è§çš„ä¹±ç 
                /ï¿½ï¿½ï¿½/g,             // ä¸‰å­—èŠ‚ä¹±ç 
                /Æ·ï¿½ï¿½ï¿½ï¿½/g,           // å•†å“åç§°çš„ä¹±ç å½¢å¼
                /ï¿½ï¿½Ë¾ï¿½ï¿½ï¿½ï¿½/g,         // å…¬å¸åç§°çš„ä¹±ç å½¢å¼
                /ï¿½Û¼ï¿½/g,            // å”®ä»·çš„ä¹±ç å½¢å¼
            ];
            
            const hasGarbledText = garbledPatterns.some(pattern => pattern.test(text));
            
            // æ£€æµ‹æ˜¯å¦åŒ…å«æ­£å¸¸çš„ä¸­æ–‡å­—ç¬¦
            const chinesePattern = /[\u4e00-\u9fa5]/g;
            const hasValidChinese = chinesePattern.test(text);
            
            // å¦‚æœæœ‰ä¹±ç ä¸”æ²¡æœ‰æ­£å¸¸ä¸­æ–‡ï¼Œå¾ˆå¯èƒ½æ˜¯ç¼–ç é—®é¢˜
            if (hasGarbledText && !hasValidChinese) {
                return 'gbk';
            }
            
            // å¦‚æœæœ‰ä¹±ç ä½†ä¹Ÿæœ‰æ­£å¸¸ä¸­æ–‡ï¼Œå¯èƒ½æ˜¯æ··åˆç¼–ç ï¼Œä¹Ÿå°è¯•è½¬æ¢
            if (hasGarbledText) {
                return 'gbk';
            }
            
            return 'utf-8';
        }
        
        // ç®€å•çš„GBKå­—ç¬¦æ›¿æ¢è½¬æ¢
        async function convertGBKToUTF8(file) {
            // ç›´æ¥ä½¿ç”¨ç®€å•çš„å®¢æˆ·ç«¯è½¬æ¢
            return simpleGBKConvert(file);
        }
        
        // ç®€å•çš„å®¢æˆ·ç«¯GBKè½¬æ¢ï¼ˆæœ‰é™æ”¯æŒï¼‰
        async function simpleGBKConvert(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let text = e.target.result;
                    
                    // ç®€å•çš„å­—ç¬¦æ›¿æ¢ï¼ˆé’ˆå¯¹å¸¸è§çš„CSVæ ‡é¢˜ï¼‰
                    const gbkMappings = {
                        'ï¿½ï¿½Æ·ï¿½ï¿½ï¿½ï¿½': 'å•†å“åç§°',
                        'ï¿½ï¿½Ë¾ï¿½ï¿½ï¿½ï¿½': 'å…¬å¸åç§°', 
                        'ï¿½Û¼ï¿½': 'å”®ä»·',
                        'ï¿½ï¿½ï¿½': 'åº“å­˜',
                        'ï¿½Å¶ï¿½ï¿½ï¿½ï¿½Ö¿Æ¼ï¿½ï¿½ï¿½ï¿½Ïºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ş¹ï¿½Ë¾': 'ä¿¡éƒ½æ•°å­—ç§‘æŠ€ï¼ˆä¸Šæµ·ï¼‰æœ‰é™å…¬å¸'
                    };
                    
                    for (const [gbk, utf8] of Object.entries(gbkMappings)) {
                        text = text.replace(new RegExp(gbk, 'g'), utf8);
                    }
                    
                    const utf8Blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
                    resolve(new File([utf8Blob], file.name, { type: 'text/csv' }));
                };
                reader.readAsText(file);
            });
        }

        // ä¸­æ–‡æ ‡é¢˜åˆ°è‹±æ–‡å­—æ®µçš„æ˜ å°„
        const fieldMapping = {
            'å•†å“åç§°': 'name',
            'å…¬å¸åç§°': 'company_name', 
            'å”®ä»·': 'price',
            'åº“å­˜': 'stock',
            'åˆ†ç±»': 'category',
            'æè¿°': 'description',
            'SKU': 'sku',
            // è‹±æ–‡æ ‡é¢˜ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            'name': 'name',
            'company_name': 'company_name',
            'price': 'price', 
            'stock': 'stock',
            'category': 'category',
            'description': 'description',
            'sku': 'sku'
        };
        
        function parseCSV(csvContent) {
            // å¤„ç†ä¸åŒçš„æ¢è¡Œç¬¦æ ¼å¼ (\r\n, \n, \r)
            const lines = csvContent.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // è·³è¿‡ç©ºè¡Œ
                const values = lines[i].split(',');
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index]?.trim() || '';
                    // ç§»é™¤å¯èƒ½çš„å¼•å·
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    
                    // ä½¿ç”¨æ˜ å°„å°†ä¸­æ–‡å­—æ®µè½¬æ¢ä¸ºè‹±æ–‡å­—æ®µ
                    const mappedField = fieldMapping[header] || header;
                    row[mappedField] = value;
                });
                
                data.push(row);
            }
            
            return data;
        }

        function displayPreview(data) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const headerRow = document.getElementById('previewHeader');
            const body = document.getElementById('previewBody');
            
            // æ˜¾ç¤ºè¡¨å¤´
            headerRow.innerHTML = headers.map(header => 
                `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">${header}</th>`
            ).join('');
            
            // æ˜¾ç¤ºå‰5è¡Œæ•°æ®
            body.innerHTML = '';
            const previewData = data.slice(0, 5);
            
            previewData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tr.innerHTML = headers.map(header => 
                    `<td class="px-4 py-2 text-sm text-gray-900 border-b">${row[header] || '-'}</td>`
                ).join('');
                body.appendChild(tr);
            });
        }

        async function previewImport() {
            if (!selectedFile || !authToken) {
                log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¹¶ç¡®ä¿å·²ç™»å½•');
                return;
            }
            
            log('ğŸ” æ­£åœ¨ç”Ÿæˆå¤„ç†é¢„è§ˆ...');
            
            const csvContent = await selectedFile.text();
            
            // é‡æ–°è§£ææ•°æ®ä»¥ç¡®ä¿åº”ç”¨æœ€æ–°çš„å­—æ®µæ˜ å°„
            const currentParsedData = parseCSV(csvContent);
            
            if (currentParsedData.length === 0) {
                log('âŒ CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                return;
            }
            
            // è·å–åŸå§‹æ ‡é¢˜ç”¨äºæ˜¾ç¤º
            const lines = csvContent.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            const originalHeaders = lines[0].split(',').map(h => h.trim());
            
            // è·å–æ˜ å°„åçš„å­—æ®µ
            const mappedHeaders = Object.keys(currentParsedData[0]);
            
            // æ£€æŸ¥å­—æ®µå®Œæ•´æ€§
            const requiredFields = ['name', 'company_name', 'price', 'stock'];
            const missingFields = requiredFields.filter(field => !mappedHeaders.includes(field));
            const extraFields = ['sku', 'category', 'description'];
            const willAddFields = extraFields.filter(field => !mappedHeaders.includes(field));
            
            let previewHtml = '<div class="space-y-4">';
            
            // å­—æ®µåˆ†æ
            previewHtml += '<div class="bg-white p-4 rounded border">';
            previewHtml += '<h4 class="font-semibold text-gray-800 mb-2">ğŸ“Š å­—æ®µåˆ†æ</h4>';
            previewHtml += `<p class="text-sm text-gray-600 mb-2">åŸå§‹å­—æ®µ (${originalHeaders.length}ä¸ª): ${originalHeaders.join(', ')}</p>`;
            previewHtml += `<p class="text-sm text-blue-600 mb-2">æ˜ å°„å­—æ®µ (${mappedHeaders.length}ä¸ª): ${mappedHeaders.join(', ')}</p>`;
            
            if (missingFields.length > 0) {
                previewHtml += `<p class="text-sm text-red-600 mb-2">âŒ ç¼ºå¤±å¿…é¡»å­—æ®µ: ${missingFields.join(', ')}</p>`;
            } else {
                previewHtml += `<p class="text-sm text-green-600 mb-2">âœ… æ‰€æœ‰å¿…é¡»å­—æ®µå®Œæ•´</p>`;
            }
            
            if (willAddFields.length > 0) {
                previewHtml += `<p class="text-sm text-blue-600">ğŸ”§ å°†è‡ªåŠ¨æ·»åŠ : ${willAddFields.join(', ')}</p>`;
            }
            previewHtml += '</div>';
            
            // ç¤ºä¾‹å¤„ç†ç»“æœ
            if (currentParsedData.length > 0 && missingFields.length === 0) {
                const sampleRow = currentParsedData[0];
                previewHtml += '<div class="bg-white p-4 rounded border">';
                previewHtml += '<h4 class="font-semibold text-gray-800 mb-2">ğŸ¯ å¤„ç†ç¤ºä¾‹ï¼ˆç¬¬1è¡Œæ•°æ®ï¼‰</h4>';
                previewHtml += '<div class="grid grid-cols-2 gap-4 text-sm">';
                
                previewHtml += '<div>';
                previewHtml += '<p class="font-medium text-gray-700 mb-2">åŸå§‹æ•°æ®:</p>';
                Object.entries(sampleRow).forEach(([key, value]) => {
                    previewHtml += `<p class="text-gray-600">${key}: ${value}</p>`;
                });
                previewHtml += '</div>';
                
                previewHtml += '<div>';
                previewHtml += '<p class="font-medium text-gray-700 mb-2">å¤„ç†å:</p>';
                previewHtml += `<p class="text-gray-600">name: ${sampleRow.name}</p>`;
                previewHtml += `<p class="text-gray-600">company_name: ${sampleRow.company_name}</p>`;
                previewHtml += `<p class="text-gray-600">price: ${sampleRow.price}</p>`;
                previewHtml += `<p class="text-gray-600">stock: ${sampleRow.stock}</p>`;
                if (!headers.includes('sku')) {
                    const fakeSku = generateSampleSku(sampleRow.name);
                    previewHtml += `<p class="text-blue-600">sku: ${fakeSku} <span class="text-xs">(è‡ªåŠ¨ç”Ÿæˆ)</span></p>`;
                }
                if (!headers.includes('category')) {
                    previewHtml += `<p class="text-blue-600">category: è¿æ¥å™¨ <span class="text-xs">(é»˜è®¤å€¼)</span></p>`;
                }
                if (!headers.includes('description')) {
                    previewHtml += `<p class="text-blue-600">description: è¿æ¥å™¨äº§å“ - ${sampleRow.name} <span class="text-xs">(è‡ªåŠ¨ç”Ÿæˆ)</span></p>`;
                }
                previewHtml += '</div>';
                previewHtml += '</div>';
                previewHtml += '</div>';
            }
            
            previewHtml += '</div>';
            
            document.getElementById('previewResult').innerHTML = previewHtml;
            document.getElementById('previewSection').classList.remove('hidden');
            
            log('âœ… å¤„ç†é¢„è§ˆç”Ÿæˆå®Œæˆ');
        }

        function generateSampleSku(name) {
            const namePrefix = name.replace(/[^a-zA-Z0-9]/g, '').slice(0, 8).toUpperCase();
            return `CONN-${namePrefix || 'PROD'}-${Date.now().toString().slice(-6)}-SAMPLE`;
        }

        async function startImport() {
            if (!selectedFile || !authToken) {
                log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¹¶ç¡®ä¿å·²ç™»å½•');
                return;
            }
            
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>å¯¼å…¥ä¸­...';
            
            log('ğŸš€ å¼€å§‹æ‰¹é‡å¯¼å…¥...');
            
            try {
                const csvContent = await selectedFile.text();
                
                const response = await axios.post(`${API_BASE}/api/products/import-csv`, {
                    csvData: csvContent
                }, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    timeout: 60000
                });
                
                if (response.data.success) {
                    const result = response.data.data;
                    showImportResult(true, result);
                    log(`âœ… å¯¼å…¥å®Œæˆ: æˆåŠŸ ${result.successCount} æ¡ï¼Œå¤±è´¥ ${result.errorCount} æ¡`);
                } else {
                    showImportResult(false, { error: response.data.error });
                    log('âŒ å¯¼å…¥å¤±è´¥: ' + response.data.error);
                }
                
            } catch (error) {
                showImportResult(false, { error: error.message });
                log('âŒ å¯¼å…¥å¼‚å¸¸: ' + error.message);
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = '<i class="fas fa-play mr-2"></i>å¼€å§‹å¯¼å…¥';
            }
        }

        function showImportResult(success, data) {
            const resultDiv = document.getElementById('importResult');
            
            if (success) {
                resultDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-6 mb-8';
                resultDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-green-800 mb-4">
                        <i class="fas fa-check-circle mr-2"></i>å¯¼å…¥æˆåŠŸï¼
                    </h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center bg-white p-3 rounded">
                            <div class="text-2xl font-bold text-green-600">${data.total}</div>
                            <div class="text-green-800 text-sm">æ€»æ•°æ®</div>
                        </div>
                        <div class="text-center bg-white p-3 rounded">
                            <div class="text-2xl font-bold text-green-600">${data.successCount}</div>
                            <div class="text-green-800 text-sm">æˆåŠŸ</div>
                        </div>
                        <div class="text-center bg-white p-3 rounded">
                            <div class="text-2xl font-bold text-red-600">${data.errorCount}</div>
                            <div class="text-red-800 text-sm">å¤±è´¥</div>
                        </div>
                    </div>
                    ${data.errors && data.errors.length > 0 ? `
                        <div class="mt-4">
                            <h4 class="font-medium text-green-800 mb-2">é”™è¯¯è¯¦æƒ…:</h4>
                            <div class="bg-white border rounded p-3 max-h-32 overflow-y-auto">
                                ${data.errors.map(error => `<p class="text-sm text-red-600">â€¢ ${error}</p>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                resultDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-6 mb-8';
                resultDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-red-800 mb-2">
                        <i class="fas fa-exclamation-circle mr-2"></i>å¯¼å…¥å¤±è´¥
                    </h3>
                    <p class="text-red-700">${data.error}</p>
                `;
            }
            
            resultDiv.classList.remove('hidden');
        }

        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.className = 'text-sm text-gray-700 mb-1';
            logEntry.textContent = `[${time}] ${message}`;
            
            if (logContainer.firstChild && logContainer.firstChild.textContent !== 'ç­‰å¾…æ“ä½œ...') {
                logContainer.insertBefore(logEntry, logContainer.firstChild);
            } else {
                logContainer.innerHTML = '';
                logContainer.appendChild(logEntry);
            }
            
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
            
            logContainer.scrollTop = 0;
        }
    </script>
</body>
</html>